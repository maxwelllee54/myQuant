# 价格复权的秘密：一个被99%散户忽视的技术细节

> **导语**：上一篇文章我们揭露了量化回测的三大陷阱，其中最隐蔽的“前视偏差”就藏在股价里。今天，我们就来彻底解密这个99%的散户都会忽视，但对量化交易至关重要的技术细节——**价格复权**。

---

欢迎来到《AI量化投资实战》系列的第二篇。

在开始之前，请记住一个核心结论：

> **如果你想做严谨的量化回测，请永远、永远、永远使用“前复权”价格。**

现在，让我们来解开这背后的秘密。

## 什么是复权？为什么需要复权？

当一家上市公司进行**分红派息**或**送股/转增股**时，它的股价会自然下跌，这被称为**除权除息**。

**[图片：除权除息日股价跳空低开示意图]**

这种下跌并不是因为公司基本面变差了，而只是一个会计调整。如果不做任何处理，你的技术指标（比如均线）会因为这个价格“断崖”而完全失真，策略也会因此产生错误的交易信号。

**复权**，就是为了消除这种影响，将历史价格进行调整，使其具有可比性。

## 三种价格，三种命运

我们通常会接触到三种价格：

1.  **不复权价格 (Nominal Price)**：最原始的价格，完全不考虑除权除息。**绝对不能用于计算收益率和回测。**

2.  **后复权价格 (Backward-Adjusted Price)**：以**今天**的价格为基准，向前调整历史价格。这是**Yahoo Finance**等大多数行情软件的默认选项。

3.  **前复权价格 (Forward-Adjusted Price)**：以**上市第一天**的价格为基准，向后调整未来价格。这是**专业量化平台**的选择。

**[表格：三种复权方式对比]**

| 特性 | 不复权 | 后复权 | 前复权 |
|---|---|---|---|
| **基准** | 无 | 当前日期 | 上市日期 |
| **调整方向** | 无 | 向前调整 | 向后调整 |
| **历史价格** | 固定不变 | **随未来事件而变** | **固定不变** |
| **Look-Ahead Bias** | 无 | 存在 | **无** |
| **推荐用于回测** | ❌ | ❌ | ✅ |

## 后复权的“原罪”：Look-Ahead Bias

上一篇我们已经用SPY的例子证明了，后复权价格会“穿越时空”，导致历史数据不可复现。这在量化中是不可饶恕的“原罪”。

**为什么会这样？**

后复权的计算公式大致是：

`历史某日后复权价 = 当日不复权价 * (今日后复权价 / 今日不复权价)`

看到问题了吗？历史价格的计算，依赖于**今天**的价格。只要未来有一次除权除息，今天的不复权价和后复权价的比例就会变，进而导致**所有**历史价格全部重新计算一遍。

## 前复权的“严谨”：历史的唯一性

前复权则完全相反。它的计算公式大致是：

`今日前复权价 = 今日不复权价 * (昨日前复权价 / 昨日不复权价)`

它的逻辑是：今天的价格，只跟昨天的价格有关系。它以股票上市第一天的价格为基准（通常设为1），然后一天天向后累乘复权因子。

**这保证了历史的唯一性**：一旦某一天的前复权价格被计算出来，它就永远不会再改变。这完美地模拟了真实交易的环境，**彻底消除了前视偏差**。

## Python实战：如何获取正确的前复权价格

光说不练假把式。下面我们用代码来演示如何获取和计算前复权价格。

### 方法一：使用Tushare Pro (推荐)

国内优秀的金融数据接口Tushare Pro直接提供了前复权数据。

```python
import tushare as ts

# 设置你的Tushare Token
pro = ts.pro_api("YOUR_TUSHARE_TOKEN")

# 获取贵州茅台的前复权日线数据
df = pro.pro_bar(ts_code=\'600519.SH\
', adj=\'qfq\', start_date=\'20200101\
')

# \'qfq\' 代表前复权
print(df.head())
```

**[图片：Tushare代码及输出截图]**

### 方法二：手动计算 (以yfinance为例)

如果你使用yfinance，它默认只提供后复权价格。但我们可以通过一个巧妙的方法来手动计算前复权价格。

**核心思想**：虽然价格本身有偏，但基于后复权价格计算出的**日收益率**是准确无偏的。我们可以利用这一点，从第一天的真实价格开始，一天天累乘收益率，来“重建”前复权价格序列。

```python
import yfinance as yf

# 1. 获取数据
ticker = yf.Ticker("AAPL")
hist = ticker.history(period="5y", auto_adjust=False) # auto_adjust=False 获取所有价格

# 2. 计算后复权收益率
hist["adj_return"] = hist["Adj Close"].pct_change()

# 3. 重建前复权价格
# 第一天的前复权价 = 第一天的真实收盘价
hist["qfq_close"] = hist["Close"].iloc[0]

# 从第二天开始，用前一天的前复权价 * (1 + 当日收益率)
for i in range(1, len(hist)):
    hist.loc[hist.index[i], "qfq_close"] = hist["qfq_close"].iloc[i-1] * (1 + hist["adj_return"].iloc[i])

print(hist[["Close", "Adj Close", "qfq_close"]].head())
```

**[图片：yfinance手动计算代码及输出截图]**

通过这个方法，我们就得到了一个干净、无偏差、可用于回测的前复权价格序列。

## 结论

价格，是量化分析的基石。如果基石本身就是松动的、错误的，那么建立在其上的任何复杂策略都将是空中楼阁。

-   **后复权**：用于看图、做技术分析。
-   **前复权**：用于计算收益率、做量化回测。

请记住，从今天起，检查你的数据源，确保你的每一行代码，都建立在**前复权**这块坚实的基石之上。

---

**下期预告**：

我们已经有了正确的数据，但如何判断一个策略的收益是来自真正的实力，还是仅仅是运气好？下一篇，我们将进入**统计学的世界**，用更硬核的工具来“拷问”我们的策略。

> **互动话题**：你之前在用什么价格做分析？有没有踩过复权的坑？欢迎在评论区交流。

**关注我们，让你的量化之路，每一步都走得更稳。** 🚀
