# 因果推断入门指南 (Causal Inference Guide)

本文件旨在为`quant-investor`技能V2.0的用户提供因果推断的基本概念及其在量化金融中的应用。

## 1. 为什么需要因果推断？ “相关性不是因果性”

在量化金融中，我们发现的大多数关系都是**相关性**，而非**因果性**。例如，我们可能发现“当MACD金叉时，未来5天的平均收益为正”。但这并不意味着是MACD金叉**导致**了收益上涨。可能存在一个共同的潜在因素（如市场情绪高涨）同时导致了MACD金叉和股价上涨。

依赖虚假的“相关性”构建策略是极其危险的，因为一旦潜在的共同因素消失或改变，策略就会立刻失效。因果推断的目标，就是尽可能地从相关性中剥离出真正的因果关系，构建更稳健、更可解释的策略。

## 2. 因果推断的核心框架

### 2.1 潜在结果框架 (Potential Outcomes Framework)

这是理解因果效应的基石。对于任何一个单元（如一只股票），我们想象它有两个潜在的结果：

- **Y(1)**: 如果该股票接受了“处理”（Treatment），例如，被某个因子选为“买入”。
- **Y(0)**: 如果该股票未接受“处理”（Control），例如，未被因子选为“买入”。

**个体因果效应 (ITE)** = Y(1) - Y(0)

**根本性难题**: 在现实世界中，我们永远无法同时观测到Y(1)和Y(0)。一只股票要么被买入，要么没被买入。我们只能观测到其中一个结果。

因果推断的各种方法，都是为了在无法直接观测到反事实的情况下，尽可能准确地估计出**平均因果效应 (Average Treatment Effect, ATE)**。

### 2.2 结构因果模型 (Structural Causal Models, SCM)

- **有向无环图 (Directed Acyclic Graphs, DAGs)**: 这是一种强大的可视化工具，用于表示变量之间的因果关系假设。
    - **节点**: 代表变量（如因子值、收益率、波动率）。
    - **有向边 (箭头)**: 代表直接的因果关系。 A -> B 表示 A 是 B 的原因。

- **DAGs的作用**:
    1.  **明确假设**: 迫使我们清晰地思考变量间的因果结构。
    2.  **识别混淆变量 (Confounders)**: 混淆变量是同时影响“处理”和“结果”的变量，是导致虚假相关性的主要来源。在DAG中，它们通常表现为 `X <- C -> Y` 的结构。
    3.  **指导分析**: DAG可以告诉我们，为了估计X对Y的纯粹因果效应，我们需要在回归中控制（“调整”）哪些变量。

## 3. 在量化金融中的应用方法

由于在金融市场中进行真正的随机对照试验（RCT）几乎是不可能的，我们转而寻找“准自然实验”或使用统计方法来模拟实验环境。

### 3.1 双重差分法 (Difference-in-Differences, DiD)

- **思想**: 比较“处理组”和“控制组”在事件发生前后的变化差异。
- **场景**: 评估某个外生事件（如**降息、纳入MSCI指数、发布特定产业政策**）对一组特定股票（处理组）相对于其他股票（控制组）的因果影响。
- **核心假设**: **平行趋势假设**。即在事件发生前，处理组和控制组的股价走势应该是平行的。
- **实践**: `causal_analyzer.py`脚本可以帮助识别这类事件，并构建DiD模型来估计ATE。

### 3.2 回归断点设计 (Regression Discontinuity Design, RDD)

- **思想**: 利用一个连续变量的某个“断点”来构造一个准实验。
- **场景**: 假设一个策略规定“当市盈率低于10倍时买入”。那么，市盈率在10倍左右的股票（如9.9倍和10.1倍）可以被认为是近似随机分配到“处理组”和“控制组”的。我们可以通过比较断点两侧股票的未来收益，来估计策略的局部因果效应。
- **优势**: 在断点附近，因果推断的有效性非常高。

### 3.3 工具变量法 (Instrumental Variables, IV)

- **思想**: 当处理变量X和结果Y之间存在混淆或双向因果时，我们寻找一个“工具变量”Z。
- **工具变量Z需满足**: 
    1.  与处理变量X相关。
    2.  只能通过X来影响结果Y，而不能有直接路径。
    3.  与影响Y的任何未观测因素都无关。
- **场景**: 这是一个高级方法，在金融中寻找好的工具变量非常困难。例如，用“公司总部所在地的天气”作为工具变量来研究“投资者情绪”对“交易行为”的影响。

## 4. `causal_analyzer.py` 脚本的功能

本技能中的因果分析脚本旨在简化上述方法的应用：

1.  **DAG构建辅助**: 提供一个交互式界面或配置文件，让用户可以方便地定义他们对因子和收益之间因果关系的假设。
2.  **混淆因素识别**: 根据用户定义的DAG，自动建议需要控制的变量。
3.  **准自然实验扫描**: 自动扫描历史数据，寻找潜在的DiD或RDD机会（例如，重大政策发布、指数成分调整等）。
4.  **模型实现**: 内置了DiD、RDD等模型的标准化实现，用户只需提供数据和定义，即可得到因果效应的估计值和其统计显著性。

## 5. 结论：从“预测”到“理解”

因果推断可能不会直接提升策略的短期收益率，但它能带来更深层次的好处：

- **策略鲁棒性**: 基于因果关系构建的策略，在市场环境变化时更不容易失效。
- **可解释性**: 让我们能够自信地解释策略为什么有效，而不仅仅是“回测结果很好”。
- **风险管理**: 帮助我们识别策略的潜在“阿喀琉斯之踵”，即策略所依赖的因果链条中最脆弱的一环。

将因果思维融入量化研究，是从优秀的“预测者”迈向智慧的“决策者”的关键一步。
